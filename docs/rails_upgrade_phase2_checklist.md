# Rails Upgrade Phase 2 Checklist

Use this checklist to complete Phase 2 ("Rails 6.1 upgrade") from `docs/rails_upgrade_plan.md`.

## A) Dependency bump and lockfile
- [x] Update `Gemfile` Rails pin from `~> 6.0.6` to `~> 6.1`.
- [x] Run `bundle update rails` under the Phase 1 Ruby baseline (`Ruby 3.2.6` / `Bundler 2.6.9`).
- [x] Confirm `Gemfile.lock` resolves to a Rails 6.1 patch release (`6.1.7.10`).
- [x] Review transitive upgrades (`activesupport`, `activerecord`, `tzinfo`, `sprockets-rails`, etc.) for obvious conflicts.

## B) Boot/runtime compatibility fixes
- [x] Validate `bundle exec rails -v` under Rails 6.1.
- [x] Validate `bundle exec rake -T` / `rake about` under Rails 6.1.
- [x] Fix Rails 6.1 + Ruby 3.2 boot regressions (added early `require 'logger'` in `config/boot.rb` for `concurrent-ruby` / `ActiveSupport::LoggerThreadSafeLevel` compatibility).

## C) Framework update task + defaults
- [x] Run `bin/rails app:update` and review prompts manually (executed with `yes n` to avoid overwriting existing configs; generated new 6.1 artifacts only).
- [x] Add `config/initializers/new_framework_defaults_6_1.rb` (generated by `app:update`; all flags remain commented for gradual enablement).
- [x] Add `config/initializers/permissions_policy.rb` (generated template; commented out).
- [x] Capture/generated Active Storage upgrade migrations:
  - `db/migrate/20260225120516_add_service_name_to_active_storage_blobs.active_storage.rb`
  - `db/migrate/20260225120517_create_active_storage_variant_records.active_storage.rb`

## D) Validation
- [x] Run app boot smoke checks (`rails -v`, `rake about`) after the upgrade.
- [x] Run full RSpec suite under Rails 6.1 with local Chrome driver override.
- [x] Record local test evidence in `docs/rails_upgrade_phase2_report.md` (`538 examples, 0 failures, 79 pending`).

## E) Deferred / environment-specific items
- [x] Staging deploy + regression checklist (N/A: app is not currently deployed; no staging environment).
- [ ] Apply database migrations in a real app environment and verify Active Storage migrations against real data.
- [ ] Enable `new_framework_defaults_6_1.rb` flags one by one with targeted regression checks.
- [ ] Review/resolve non-blocking warnings (existing autoload deprecation and any Rails 6.1 warnings) before Phase 3.

## Notes (2026-02-25)
- Full-suite command used for JS/system specs:
  - `CHROMEDRIVER_PATH="$(command -v chromedriver)" bundle exec rspec -f j -o rspec_phase2_rails61_after_app_update.json`
- `rails app:update` also normalized executable bits on Rails binstubs (`bin/*`); no binstub content changes were introduced in this pass.
- `config.load_defaults` remains `6.0` in `config/application.rb` intentionally; the generated `new_framework_defaults_6_1.rb` file is the place to enable 6.1 behavior changes gradually.
